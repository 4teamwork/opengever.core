version: "3"

services:
  httpd:
    image: 4teamwork/oghttpd:latest
    build:
      context: .
      dockerfile: ./docker/httpd/Dockerfile
    ports:
      - "8081:80"
    depends_on:
      - ogui
      - ogcore
    environment:
      - HTTP_PROTOCOL=http
      - HTTP_PORT=8081
    profiles:
      - all
  msgconvert:
    image: 4teamwork/msgconvert:latest
    ports:
      - 8090:8080
  sablon:
    image: 4teamwork/sablon:latest
    ports:
      - 8091:8080
  pdflatex:
    image: 4teamwork/pdflatex:latest
    ports:
      - 8092:8080
  weasyprint:
    image: 4teamwork/weasyprint:latest
    ports:
      - 8093:8080
  clamav:
    image: mkodockx/docker-clamav:alpine
    ports:
      - 3310:3310
    profiles:
      - clamav
  ogui:
    image: 4teamwork/ogui:latest
    profiles:
      - all
  ogcore:
    build:
      context: .
      dockerfile: ./docker/core/Dockerfile
    image: 4teamwork/ogcore:latest
    volumes:
      - ./var/ogcore:/data
    ports:
      - "8080:8080"
      - "8160:8160"
    environment:
      - STORAGE=zeoclient
    depends_on:
      - zeoserver
      - ogds
      - solr
    profiles:
      - all
      - ogcore
  zeoserver:
    image: 4teamwork/zeoserver:4.3.20
    volumes:
      - ./var/ogcore:/data
    profiles:
      - all
      - ogcore
  ogds:
    image: postgres:12-alpine
    volumes:
      - ./var/ogds:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=ogds
      - POSTGRES_PASSWORD=secret
      - POSTGRES_DB=ogds
    ports:
      - 15432:5432
    profiles:
      - all
      - ogds
  solr:
    image: 4teamwork/ogsolr:latest
    build:
      context: .
      dockerfile: ./docker/solr/Dockerfile
    command:
      - solr-precreate
      - ogsite
      - /opt/solr/server/solr/configsets/ogsite
    volumes:
      - ./var/solr:/var/solr/data
    ports:
      - 18983:8983
    profiles:
      - all
      - solr
  389ds:
    image: 4teamwork/389ds:2.0.4
    ports:
      - "3389:3389"
      - "3636:3636"
    volumes:
      - ./var/389ds:/data
    environment:
      - SUFFIX_NAME=dc=example,dc=com
      - DS_DM_PASSWORD=secret
    profiles:
      - all
      - 389ds
