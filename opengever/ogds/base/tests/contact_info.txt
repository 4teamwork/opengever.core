Imports / globals:

    >>> from Products.CMFCore.utils import getToolByName
    >>> from opengever.ogds.base.interfaces import IContactInformation
    >>> from opengever.ogds.models.client import Client
    >>> from opengever.ogds.models.user import User
    >>> from opengever.ogds.base.setuphandlers import _create_example_client
    >>> from opengever.ogds.base.setuphandlers import _create_example_user
    >>> from opengever.ogds.base.testing import create_contacts
    >>> from opengever.ogds.base.utils import create_session, get_current_client
    >>> from opengever.ogds.base.utils import get_client_id
    >>> from zope.component import getUtility

    >>> app = layer.get('app')
    >>> portal = layer.get('portal')

Log in
    >>> from plone.app.testing import login
    >>> from plone.app.testing import TEST_USER_NAME
    >>> login(portal, TEST_USER_NAME)

Lets create some users:

    >>> session = create_session()

    >>> _create_example_user(session, portal,
    ...                      'hugo.boss',
    ...                      {'firstname': 'Hugo',
    ...                       'lastname': 'Boss',
    ...                       'email': 'hugo@boss.local',
    ...                       'email2': 'hugo@private.ch'},
    ...                      ('client1_users',
    ...                       'client1_inbox_users'))

    >>> _create_example_user(session, portal,
    ...                      'peter.muster',
    ...                      {'firstname': 'Peter',
    ...                       'lastname': 'Muster'},
    ...                      ('client2_users',
    ...                       'client2_inbox_users'))

    >>> _create_example_user(session, portal,
    ...                      'hanspeter.linder',
    ...                      {'firstname': 'hanspeter',
    ...                       'lastname': 'linder'},
    ...                      ('client2_users', 'client1_users'))




And we also need some clients:


    >>> _create_example_client(session, 'client1',
    ...                       {'title': 'Client 1',
    ...                        'ip_address': '127.0.0.1',
    ...                        'site_url': 'http://nohost/client1',
    ...                        'public_url': 'http://nohost/client1',
    ...                        'group': 'client1_users',
    ...                        'inbox_group': 'client1_inbox_users'})

    >>> _create_example_client(session, 'client2',
    ...                       {'title': 'Client 2',
    ...                        'ip_address': '127.0.0.1',
    ...                        'site_url': 'http://nohost/client2',
    ...                        'public_url': 'http://nohost/client2',
    ...                        'group': 'client2_users',
    ...                        'inbox_group': 'client2_inbox_users'})

the ip_address column should also work with a comma seperated list

    >>> _create_example_client(session, 'client3',
    ...                       {'title': 'Client 3',
    ...                        'enabled': False,
    ...                        'ip_address': '127.0.0.1,192.168.1.2',
    ...                        'site_url': 'http://nohost/client3',
    ...                        'public_url': 'http://nohost/client3',
    ...                        'group': 'client3_users',
    ...                        'inbox_group': 'client3_inbox_users'})


Create some local contacts:

    >>> create_contacts(portal)
    >>> len(portal.contacts.objectIds())
    3


Get the current client (see layer testing.py):

    >>> get_client_id()
    u'client1'

    >>> get_current_client()
    <Client client1>


Get the contact information utlity:

    >>> info = getUtility(IContactInformation)


User tests:

    >>> len(info.list_users())
    3
    >>> [u.userid for u in info.list_users()]
    [u'hugo.boss', u'peter.muster', u'hanspeter.linder']
    >>> info.is_user('hugo.boss')
    True
    >>> info.is_contact('hugo.boss')
    False
    >>> info.is_inbox('hugo.boss')
    False
    >>> info.get_user('hugo.boss')
    <User hugo.boss>

    >>> print info.get_user('someone.unknown')
    None
    >>> info.get_user('inbox:client1')
    Traceback (most recent call last):
    ...
    ValueError: principal inbox:client1 is not a user
    >>> info.describe('hugo.boss')
    u'Boss Hugo (hugo.boss)'
    >>> info.describe('hugo.boss', with_email=True)
    u'Boss Hugo (hugo.boss, hugo@boss.local)'
    >>> info.describe('hugo.boss', with_principal=False)
    u'Boss Hugo'
    >>> info.describe('hugo.boss', with_email=True, with_principal=False)
    u'Boss Hugo (hugo@boss.local)'
    >>> info.describe(info.get_user('hugo.boss'))
    u'Boss Hugo (hugo.boss)'

    >>> info.get_email('hugo.boss')
    u'hugo@boss.local'
    >>> info.get_email(info.get_user('hugo.boss'))
    u'hugo@boss.local'
    >>> info.get_email2('hugo.boss')
    u'hugo@private.ch'
    >>> info.get_email2(info.get_user('hugo.boss'))
    u'hugo@private.ch'

    >>> info.get_profile_url('hugo.boss')
    u'http://nohost/plone/@@user-details/hugo.boss'

    >>> info.render_link('hugo.boss')
    u'<a href="http://nohost/plone/@@user-details/hugo.boss">Boss Hugo (hugo.boss)</a>'


Contacts tests:

    >>> contacts = info.list_contacts()
    >>> contacts
    [<Products.ZCatalog.Catalog.mybrains object at ...>, <Products.ZCatalog.Catalog.mybrains object at ...>, <Products.ZCatalog.Catalog.mybrains object at ...>]

    >>> contacts[0].contactid
    'contact:kaufmann-sandra'

    >>> info.is_contact('contact:kaufmann-sandra')
    True

    >>> sandra = info.get_contact('contact:kaufmann-sandra')
    >>> sandra
    <Products.ZCatalog.Catalog.mybrains object at ...>

    >>> sandra.firstname
    u'Sandra'
    >>> sandra.lastname
    u'Kaufmann'
    >>> sandra.email
    'sandra.kaufmann@test.ch'
    >>> info.describe('contact:kaufmann-sandra')
    u'Kaufmann Sandra (sandra.kaufmann@test.ch)'
    >>> info.describe(u'contact:kaufmann-sandra')
    u'Kaufmann Sandra (sandra.kaufmann@test.ch)'
    >>> info.describe(u'contact:kaufmann-sandra', with_principal=False)
    u'Kaufmann Sandra'
    >>> info.describe(contacts[0])
    u'Kaufmann Sandra (sandra.kaufmann@test.ch)'
    >>> info.get_email(u'contact:kaufmann-sandra')
    'sandra.kaufmann@test.ch'
    >>> info.get_email(info.get_contact('contact:kaufmann-sandra'))
    'sandra.kaufmann@test.ch'


Inboxes tests:

    >>> tuple(info.list_inboxes())
    ((u'inbox:client1', u'Inbox: Client 1'), (u'inbox:client2', u'Inbox: Client 2'))
    >>> info.is_inbox(u'inbox:client1')
    True
    >>> info.is_user(u'inbox:client1')
    False
    >>> info.is_contact(u'inbox:client1')
    False
    >>> info.get_client_of_inbox(u'inbox:client1')
    <Client client1>
    >>> info.get_group_of_inbox(u'inbox:client1')
    u'client1_inbox_users'

    >>> info.describe(u'inbox:client1')
    u'Inbox: Client 1'
    >>> info.describe(u'inbox:client1', with_principal=False)
    u'Inbox: Client 1'


Various lists and other methods:

    >>> list(info.list_assigned_users())
    [<User hanspeter.linder>, <User hugo.boss>]

    >>> list(info.list_assigned_users(client_id='client2'))
    [<User hanspeter.linder>, <User peter.muster>]

    >>> list(info.get_assigned_clients(userid='hugo.boss'))
    [<Client client1>]

    >>> list(info.get_assigned_clients(userid='hanspeter.linder'))
    [<Client client1>, <Client client2>]

    >>> info.is_client_assigned(userid='hugo.boss', client_id='client2')
    False

    >>> info.is_client_assigned(userid='hugo.boss', client_id='client1')
    True

    >>> list(info.list_group_users('client2_users'))
    [<User hanspeter.linder>, <User peter.muster>]

    >>> list(info.list_group_users('not_existing_groupid'))
    []

    >>> list(info.get_clients())
    [<Client client1>, <Client client2>]

    >>> info.get_client_by_id('client1')
    <Client client1>

    >>> print info.get_client_by_id('client3')
    None

    >>> print info.get_client_by_id('unknown client')
    None

    >>> list(info.list_user_groups('hugo.boss'))
    [<Group client1_users>, <Group client1_inbox_users>]

    >>> info.is_user_in_inbox_group(
    ...    userid='hugo.boss', client_id='client1')
    True

    >>> info.is_user_in_inbox_group(
    ...    userid='hugo.boss', client_id='client2')
    False

    >>> info.is_user_in_inbox_group(
    ...    userid='hanspeter.linder', client_id='client1')
    False

    >>> info.is_user_in_inbox_group(
    ...    userid='hanspeter.linder', client_id='notexists')
    False

    >>> info.is_group_member(u'client1_inbox_users', u'hugo.boss')
    True

    >>> info.is_group_member(u'client1_inbox_users', u'hanspeter.linder')
    False

check the sort dictionaries

    >>> info.get_user_sort_dict()
    {u'hugo.boss': u'Boss Hugo',
     u'hanspeter.linder': u'linder hanspeter',
     u'inbox:client2': u'Inbox: Client 2',
     u'peter.muster': u'Muster Peter',
     u'inbox:client1': u'Inbox: Client 1'}

    >>> info.get_user_contact_sort_dict()
    {u'inbox:client1': u'Inbox: Client 1',
    'contact:wermuth-roger': u'Wermuth Roger',
    'contact:kaufmann-sandra': u'Kaufmann Sandra',
    'contact:kappeli-elisabeth': u'K\xe4ppeli Elisabeth',
    u'hugo.boss': u'Boss Hugo',
    u'inbox:client2': u'Inbox: Client 2',
    u'hanspeter.linder': u'linder hanspeter',
    u'peter.muster': u'Muster Peter'}

Test describe with a PAS user:

    >>> info.describe('test_user_1_')
    ' (test_user_1_)'
    >>> info.describe('test_user_1_', with_principal=False)
    ''
    >>> info.describe('non-existing-user')
    u'non-existing-user'
