test searching data

    >>> import transaction
    >>> from plone.dexterity.utils import createContentInContainer
    >>> from plone.testing.z2 import Browser
    >>> from plone.app.testing import TEST_USER_NAME, TEST_USER_PASSWORD

setup the browser for the test, we use it later in the test
	>>> app = layer['app']
	>>> portal = layer['portal']
    >>> browser = Browser(app)
    >>> portal_url = portal.absolute_url()
    >>> browser.handleErrors = False

create 2 dossiers
    >>> dossier1 = createContentInContainer(portal,
    ...     'opengever.dossier.businesscasedossier',
    ...     title='Dossier1', checkConstraints=False)
    >>> dossier1
    <DossierContainer at ...>

    >>> dossier2 = createContentInContainer(portal,
    ...     'opengever.dossier.businesscasedossier',
    ...     title='Dossier2', checkConstraints=False)
    >>> dossier2
    <DossierContainer at ...>


create 2 documents

	>>> doc1 = createContentInContainer(dossier1,
	...     'opengever.document.document',
	...     title='Document1', checkConstraints=False)
	>>> doc1
	<Document at ...>

	>>> doc2 = createContentInContainer(dossier2,
	...     'opengever.document.document',
	...     title='Document2', checkConstraints=False)
	>>> doc2
	<Document at ...>

create 2 tasks

  >>> task1 = createContentInContainer(dossier1,
  ...     'opengever.task.task',
  ...     title='Task1', checkConstraints=False)
  >>> task1
  <Task at ...>

  >>> task2 = createContentInContainer(dossier2,
  ...     'opengever.task.task',
  ...     title='Task2', checkConstraints=False)
  >>> task2
  <Task at ...>

    >>> transaction.commit()

login
    >>> browser.open('%s/login_form' % portal_url)
    >>> browser.getControl(name='__ac_name').value = TEST_USER_NAME
    >>> browser.getControl(name='__ac_password').value = TEST_USER_PASSWORD
    >>> browser.getControl(name='submit').click()

search dossiers
    >>> browser.open('%s/advanced_search' % dossier1.absolute_url())
    >>> browser.getControl(name='form.widgets.searchableText').value = "dossier1"
    >>> browser.getControl(name='form.widgets.object_provides:list').value = ['opengever.dossier.behaviors.dossier.IDossierMarker']
    >>> browser.getControl(name='form.buttons.button_search').click()
    >>> '1 items matching your search terms' in browser.contents
    True
    >>> browser.open('http://nohost/plone/search?object_provides=opengever.dossier.behaviors.dossier.IDossierMarker&SearchableText=dossier1')


search documents (we can't find the document because we must change the content-type)
    >>> browser.open('%s/advanced_search' % dossier1.absolute_url())
    >>> browser.getControl(name='form.widgets.searchableText').value = "document1"
    >>> browser.getControl(name='form.widgets.object_provides:list').value = ['opengever.dossier.behaviors.dossier.IDossierMarker']
    >>> browser.getControl(name='form.buttons.button_search').click()
    >>> '0 items matching your search terms' in browser.contents
    True
    >>> browser.open('http://nohost/plone/search?object_provides=opengever.dossier.behaviors.dossier.IDossierMarker&SearchableText=document1')


search documents with the right content-type
    >>> browser.open('%s/advanced_search' % dossier1.absolute_url())
    >>> browser.getControl(name='form.widgets.searchableText').value = "document1"
    >>> browser.getControl(name='form.widgets.object_provides:list').value = ['opengever.document.behaviors.IBaseDocument']
    >>> browser.getControl(name='form.buttons.button_search').click()
    >>> browser.open('http://nohost/plone/search?object_provides=opengever.document.behaviors.IBaseDocument&SearchableText=document1')
    >>> '1 items matching your search terms' in browser.contents
    True

search tasks (we can't find the task because we must change the content-type)
    >>> browser.open('%s/advanced_search' % dossier1.absolute_url())
    >>> browser.getControl(name='form.widgets.searchableText').value = "task1"
    >>> browser.getControl(name='form.widgets.object_provides:list').value = ['opengever.document.behaviors.IBaseDocument']
    >>> browser.getControl(name='form.buttons.button_search').click()
    >>> '0 items matching your search terms' in browser.contents
    True
    >>> browser.open('http://nohost/plone/search?object_provides=opengever.document.behaviors.IBaseDocument&SearchableText=task1')


search tasks with the right content-type
    >>> browser.open('%s/advanced_search' % dossier1.absolute_url())
    >>> browser.getControl(name='form.widgets.searchableText').value = "task1"
    >>> browser.getControl(name='form.widgets.object_provides:list').value = ['opengever.task.task.ITask']
    >>> browser.getControl(name='form.buttons.button_search').click()
    >>> '1 items matching your search terms' in browser.contents
    True
    >>> browser.open('http://nohost/plone/search?object_provides=opengever.task.task.ITask&SearchableText=task1')


# validate created searchstring for dossiers
    >>> browser.open('%s/advanced_search' % dossier1.absolute_url())
    >>> browser.getControl(name='form.widgets.searchableText').value = "dossier1"
    >>> browser.getControl(name='form.widgets.object_provides:list').value = ['opengever.dossier.behaviors.dossier.IDossierMarker']
    >>> browser.getControl(name='form.widgets.start_1').value = "01.01.2010"
    >>> browser.getControl(name='form.widgets.start_2').value = "01.02.2010"
    >>> browser.getControl(name='form.widgets.end_1').value = "01.03.2010"
    >>> browser.getControl(name='form.widgets.end_2').value = "01.04.2010"
    >>> browser.getControl(name='form.widgets.reference').value = "OG 14.2"
    >>> browser.getControl(name='form.widgets.sequence_number').value = "5"
    >>> browser.getControl(name='form.widgets.searchable_filing_no').value = "14"
    >>> browser.getControl(name='form.widgets.dossier_review_state:list').value = ['dossier-state-active']
    >>> browser.getControl(name='form.buttons.button_search').click()
    >>> browser.url
    'http://nohost/plone/search?object_provides=opengever.dossier.behaviors.dossier.IDossierMarker&SearchableText=dossier1&start_usage=range:minmax&start:list=01/01/10&start:list=02/02/10&end_usage=range:minmax&end:list=03/01/10&end:list=04/02/10&reference=OG%2014.2&sequence_number:int=5&searchable_filing_no=14&review_state:list=dossier-state-active'

# validate created searchstring for documents
    >>> browser.open('%s/advanced_search' % dossier1.absolute_url())
    >>> browser.getControl(name='form.widgets.searchableText').value = "document1"
    >>> browser.getControl(name='form.widgets.object_provides:list').value = ['opengever.document.behaviors.IBaseDocument']
    >>> browser.getControl(name='form.widgets.receipt_date_1').value = "01.01.2010"
    >>> browser.getControl(name='form.widgets.receipt_date_2').value = "01.02.2010"
    >>> browser.getControl(name='form.widgets.delivery_date_1').value = "01.03.2010"
    >>> browser.getControl(name='form.widgets.delivery_date_2').value = "01.04.2010"
    >>> browser.getControl(name='form.widgets.document_author').value = "Eduard"
    >>> browser.getControl(name='form.widgets.trashed:list').value = True
    >>> browser.getControl(name='form.buttons.button_search').click()
    >>> browser.url
    'http://nohost/plone/search?object_provides=opengever.document.behaviors.IBaseDocument&SearchableText=document1&receipt_date_usage=range:minmax&receipt_date:list=01/01/10&receipt_date:list=02/02/10&delivery_date_usage=range:minmax&delivery_date:list=03/01/10&delivery_date:list=04/02/10&document_author=Eduard&trashed:list:boolean=True&trashed:list:boolean=False'

# validate created searchstring for task
    >>> browser.open('%s/advanced_search' % dossier1.absolute_url())
    >>> browser.getControl(name='form.widgets.searchableText').value = "task1"
    >>> browser.getControl(name='form.widgets.object_provides:list').value = ['opengever.task.task.ITask']
    >>> browser.getControl(name='form.widgets.deadline_1').value = "01.01.2010"
    >>> browser.getControl(name='form.widgets.deadline_2').value = "01.01.2010"
    >>> browser.getControl(name='form.widgets.task_type:list').value = ['information']
    >>> browser.getControl(name='form.widgets.dossier_review_state:list').value = ['dossier-state-active']
    >>> browser.getControl(name='form.buttons.button_search').click()
    >>> browser.url
    'http://nohost/plone/search?object_provides=opengever.task.task.ITask&SearchableText=task1&deadline_usage=range:minmax&deadline:list=01/01/10&deadline:list=01/02/10&task_type=information'

check disabling unloadProtection
    >>> browser.open('%s/advanced_search' %(portal_url))
    >>> 'enableUnloadProtection' not in browser.contents
    True
