copy_item function
==================

    >>> portal = layer['portal']
    >>> app = layer['app']

    >>> from plone.app.testing import setRoles
    >>> from plone.app.testing import TEST_USER_ID
    >>> import transaction
    >>> setRoles(portal, TEST_USER_ID, ['Contributor'])
    >>> transaction.commit()

imports:

    >>> request = layer.get('request')
    >>> from plone.dexterity.fti import DexterityFTI
    >>> from Products.CMFCore.utils import getToolByName

    >>> ptool = getToolByName(portal, 'plone_utils')
    >>> from OFS.CopySupport import _cb_decode
    >>> from plone.dexterity.utils import createContentInContainer

create test container and object fti:
    >>> container = DexterityFTI('OpenGeverBaseContainer',
    ...         klass="plone.dexterity.content.Container",
    ...         global_allow=True, filter_content_types=False)
    >>> portal.portal_types._setObject('OpenGeverBaseContainer', container)
    'OpenGeverBaseContainer'
    >>> fti = DexterityFTI('OpenGeverBaseFTI2')
    >>> fti.schema = 'opengever.base.testing.IEmptySchema'
    >>> fti.behaviors = (
    ...                  'opengever.base.behaviors.base.IOpenGeverBase',
    ...                  )
    >>> portal.portal_types._setObject('OpenGeverBaseFTI2', fti)
    'OpenGeverBaseFTI2'

create test objects:
    >>> createContentInContainer(portal, 'OpenGeverBaseContainer', title=u'container')
    <Container at /plone/opengeverbasecontainer>
    >>> folder = portal['opengeverbasecontainer']
    >>> createContentInContainer(folder, 'OpenGeverBaseFTI2', title=u'doc')
    <Item at /plone/opengeverbasecontainer/opengeverbasefti2>
    >>> doc = folder['opengeverbasefti2']

test copy_items view:
we have to fake the request since copy_items view will redirect to the orig_template
    >>> request.form['orig_template'] = folder.absolute_url()


should select any items
    >>> folder.restrictedTraverse('copy_items')()
    'http://nohost/plone/opengeverbasecontainer'
    >>> ptool.showPortalMessages()[-1].message
    u'You have not selected any Items'

Fake Itemselection
    >>> portal.REQUEST['paths'] = ['/'.join(doc.getPhysicalPath())]
    >>> folder.restrictedTraverse('copy_items')()
    'http://nohost/plone/opengeverbasecontainer'
    >>> '__cp' in portal.REQUEST.keys()
    True

Check if Item has been saved to REQUEST
    >>> _cb_decode(portal.REQUEST['__cp'])
    (0, [('', 'plone', 'opengeverbasecontainer', 'opengeverbasefti2')])

Add Second Item to test with multiple Items Selected
    >>> createContentInContainer(folder, 'OpenGeverBaseFTI2', title=u'doc2')
    <Item at /plone/opengeverbasecontainer/opengeverbasefti2-1>
    >>> doc2 = folder['opengeverbasefti2-1']

Add Item to Paths
    >>> portal.REQUEST['paths'].append('/'.join(doc2.getPhysicalPath()))
    >>> folder.restrictedTraverse('copy_items')()
    'http://nohost/plone/opengeverbasecontainer'
    >>> '__cp' in portal.REQUEST.keys()
    True

Test if they were copied correctly
    >>> copiedItems = portal.REQUEST['__cp'].split(':')
    >>> _cb_decode(copiedItems[0])
    (0, [('', 'plone', 'opengeverbasecontainer', 'opengeverbasefti2')])
    >>> _cb_decode(copiedItems[1])
    (0, [('', 'plone', 'opengeverbasecontainer', 'opengeverbasefti2-1')])

Take away Copy permission
    >>> doc.manage_permission('Copy or Move', [], acquire=False)
    >>> folder.restrictedTraverse('copy_items')()
    'http://nohost/plone/opengeverbasecontainer'

Should not be able to copy the file
    >>> ptool.showPortalMessages()[-1].message
    u'The item you selected cannot be copied'
