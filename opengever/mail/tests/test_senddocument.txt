Test views:
===========

imports and general stuff
    >>> from Products.CMFPlone.tests.utils import MockMailHost
    >>> from Products.MailHost.interfaces import IMailHost
    >>> from opengever.mail.interfaces import ISendDocumentConf
    >>> from opengever.mail.interfaces import ISendableDocsContainer
    >>> from plone.app.testing.interfaces import TEST_USER_NAME as portal_owner, TEST_USER_PASSWORD as default_password
    >>> from plone.dexterity.interfaces import IDexterityFTI
    >>> from plone.dexterity.utils import createContentInContainer
    >>> from plone.namedfile.file import NamedBlobFile
    >>> from plone.registry.interfaces import IRegistry
    >>> from plone.testing.z2 import Browser
    >>> from zope.component import getUtility
    >>> from zope.component import queryUtility
    >>> from zope.interface import alsoProvides
    >>> from zope.site.hooks import getSite
    >>> from zope.schema import getFields
    >>> import transaction

    >>> app = layer['app']
    >>> portal = layer['portal']
    >>> browser = Browser(app)
    >>> browser.handleErrors = False

    >>> portal.manage_setLocalRoles('mail-test', ['Owner','Editor','Contributor'])

create document
    >>> doc1 = createContentInContainer(portal, 'opengever.document.document', title=u'Document 1')

create a mail
    >>> fti = getUtility(IDexterityFTI, name='ftw.mail.mail')
    >>> schema = fti.lookupSchema()
    >>> field_type = getFields(schema)['message']._type
    >>> msgtxt = 'Mime-Version: 1.0\nContent-Type: multipart/mixed; boundary=908752978\nTo: to@example.org\nFrom: from@example.org\nSubject: Attachment Test\nDate: Thu, 01 Jan 1970 01:00:00 +0100\nMessage-Id: <1>\n\n\n--908752978\nContent-Disposition: attachment;\n	filename*=iso-8859-1''B%FCcher.txt\nContent-Type: text/plain;\n	name="=?iso-8859-1?Q?B=FCcher.txt?="\nContent-Transfer-Encoding: base64\n\nw6TDtsOcCg==\n\n--908752978--\n'

    >>> mail1 = createContentInContainer(portal, 'ftw.mail.mail',
    ...     message=field_type(data=msgtxt,
    ...          contentType=u'message/rfc822', filename=u'attachment.txt'))

portal has to provide ISendableDocsContainer
    >>> alsoProvides(portal, ISendableDocsContainer)
    >>> ISendableDocsContainer.providedBy(portal)
    True
    >>> transaction.commit()

login
    >>> browser.open('%s/login_form' % portal.absolute_url())
    >>> browser.getControl(name='__ac_name').value = 'mail-test'
    >>> browser.getControl(name='__ac_password').value = 'demo09'
    >>> browser.getControl(name='submit').click()

Mock MailHost
    >>> mockmailhost = MockMailHost('MailHost')
    >>> doc1.MailHost = mockmailhost
    >>> portal.MailHost = mockmailhost
    >>> sm = getSite().getSiteManager()
    >>> sm.registerUtility(component=mockmailhost,
    ...                    provided=IMailHost)
    >>> transaction.commit()

test form
    >>> data = 'paths:list=%s'% '/'.join(doc1.getPhysicalPath())
    >>> browser.open('%s/send_documents' % portal.absolute_url(), data=data)
    >>> browser.getControl(name='form.widgets.subject').value = 'Test Betreff'
    >>> browser.getControl(name='form.widgets.message').value = 'Test Nachricht'

    >>> browser.getControl(name='form.widgets.documents:list').value == ['/'.join(doc1.getPhysicalPath())]
    True
    >>> browser.getControl(name='form.buttons.button_send').click()
    >>> 'You have to select a intern                             '\
    ... 'or enter a extern mail-addres' in browser.contents
    True
    >>> browser.getControl(name='form.widgets.extern_receiver').value = 'info@4teamwork.ch'
    >>> browser.getControl(name='form.buttons.button_send').click()
    >>> len(doc1.MailHost.messages)
    1
    >>> 'Test Nachricht' in doc1.MailHost.messages[0]
    True

Test again (now document have a file)
    >>> mok_file1 = NamedBlobFile(500000*'bla', filename=u'test.txt')
    >>> doc1.file = mok_file1
    >>> data = 'paths:list=%s'% '/'.join(doc1.getPhysicalPath())
    >>> transaction.commit()
    >>> browser.open('%s/send_documents' % portal.absolute_url(), data=data)
    >>> browser.getControl(name='form.widgets.subject').value = 'Test Betreff'
    >>> browser.getControl(name='form.widgets.message').value = 'Test Nachricht'
    >>> browser.getControl(name='form.widgets.extern_receiver').value = 'info@4teamwork.ch'

max size to small
    >>> registry = queryUtility(IRegistry)
    >>> reg_proxy = registry.forInterface(ISendDocumentConf)
    >>> reg_proxy.max_size = 1
    >>> transaction.commit()
    >>> browser.getControl(name='form.buttons.button_send').click()
    >>> 'The files you selected are larger than the maximum size' in browser.contents
    True

max size ok
    >>> reg_proxy.max_size = 5
    >>> transaction.commit()
    >>> browser.getControl(name='form.buttons.button_send').click()
    >>> len(doc1.MailHost.messages)
    2
    >>> 'Test Nachricht' in doc1.MailHost.messages[1]
    True

validator should also work with mails ect
    >>> data = 'paths:list=%s'% '/'.join(mail1.getPhysicalPath())
    >>> browser.open('%s/send_documents' % portal.absolute_url(), data=data)
    >>> browser.getControl(name='form.widgets.documents:list').value == ['/'.join(mail1.getPhysicalPath())]
    True

    >>> browser.getControl(name='form.widgets.subject').value = 'Test Betreff 2'
    >>> browser.getControl(name='form.widgets.message').value = 'Test Nachricht 2'
    >>> browser.getControl(name='form.widgets.extern_receiver').value = 'info@4teamwork.ch'
    >>> browser.getControl(name='form.buttons.button_send').click()
    >>> len(doc1.MailHost.messages)
    3
    >>> 'Test Nachricht' in doc1.MailHost.messages[1]
    True
