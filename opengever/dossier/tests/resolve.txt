Resolve and archive a dossier
=============================

Resolving
=========
In this test we check the rules for resolving a Dossier

do some imports
    >>> import transaction
    >>> from plone.dexterity.utils import createContentInContainer
    >>> from zope.component import getMultiAdapter
    >>> from plone.testing.z2 import Browser
    >>> from datetime import datetime
    >>> from opengever.dossier.behaviors.dossier import IDossier
    >>> from opengever.document.interfaces import ICheckinCheckoutManager
    >>> from zope.component import queryMultiAdapter
    >>> from plone.indexer.interfaces import IIndexableObject
    >>> from plone.app.testing import TEST_USER_ID

setup the browser for the test, we use it later in the test
    >>> app = layer['app']
    >>> portal = layer['portal']
    >>> browser = Browser(app)
    >>> browser.handleErrors = False
    >>> browser.addHeader('Accept-Language', 'en-US')
    >>> app.acl_users.userFolderAddUser('root', 'secret',
    ...                                ['Manager','Contributor', 'Reviewer', 'Administrator'], [])
    >>> browser.addHeader('Authorization', 'Basic root:secret' )
    >>> portal.manage_setLocalRoles('root', ['Reviewer',])

creating dossier, ...
    >>> dossier = createContentInContainer(portal,
    ...     'opengever.dossier.businesscasedossier',
    ...     title='Dossiers', checkConstraints=False)
    >>> dossier
    <DossierContainer at /plone/dossier-1>
    >>> IDossier(dossier).start = datetime.today().date()

subdossier, ...
    >>> subdossier = createContentInContainer(dossier,
    ...     'opengever.dossier.businesscasedossier',
    ...     title='Subdossier', checkConstraints=False)
    >>> subdossier
    <DossierContainer at /plone/dossier-1/dossier-2>
    >>> IDossier(subdossier).start = datetime.today().date()


documents, ...
    >>> doc1 = createContentInContainer(dossier,
    ...     'opengever.document.document', title="Doc1", checkConstraints=False)
    >>> doc1
    <Document at /plone/dossier-1/document-1>

and tasks,
    >>> task1 = createContentInContainer(dossier,
    ...     'opengever.task.task', title="Task1", task_type='correction', checkConstraints=False)
    >>> task1
    <Task at /plone/dossier-1/task-1>
    >>> task1.responsible = TEST_USER_ID

    >>> task2 = createContentInContainer(subdossier,
    ...     'opengever.task.task', title="Task1", task_type='correction', issuer=str(portal.restrictedTraverse('plone_portal_state').member()), checkConstraints=False)
    >>> task2
    <Task at /plone/dossier-1/dossier-2/task-2>


in plone.app.testing we need to commit the transaction before we can use the content with the browser.
    >>> transaction.commit()


is all supplied
---------------
Check if all contents of the dossier are "supplied" (filed)
    >>> dossier.is_all_supplied()
    False

Check that an inactive subdossier doesn't prevent the main dossier from being closed
    >>> wft = portal.portal_workflow
    >>> wft.doActionFor(subdossier, 'dossier-transition-deactivate')
    >>> dossier.is_all_supplied()
    True

Create another subdossier to continue with testing...
    >>> subdossier = createContentInContainer(dossier,
    ...     'opengever.dossier.businesscasedossier',
    ...     title='Subdossier', checkConstraints=False)
    >>> subdossier
    <DossierContainer at /plone/dossier-1/dossier-3>
    >>> IDossier(subdossier).start = datetime.today().date()

Move the object to the subdossier, the task rest in the maindossier, and check is all supplied
    >>> clibboard = dossier.manage_cutObjects(
    ...    [doc1.getId(),])
    >>> result = subdossier.manage_pasteObjects(clibboard)
    >>> doc1 = getattr(subdossier, result[0].get('new_id'))
    >>> dossier.is_all_supplied()
    False

Move also the task to the subdossier and now all should be supplied
    >>> clibboard = dossier.manage_cutObjects(
    ...    [task1.getId(),])
    >>> result = subdossier.manage_pasteObjects(clibboard)
    >>> task1 = getattr(subdossier, 'task-1')
    >>> dossier.is_all_supplied()
    True



is_all_checked_in
-----------------
test the is_all_checked_in method
    >>> wft = portal.portal_workflow
    >>> wft.getInfoFor(doc1, 'review_state')
    'document-state-draft'
    >>> dossier.is_all_checked_in()
    True
    >>> manager = getMultiAdapter((doc1, app.REQUEST), ICheckinCheckoutManager)
    >>> manager.checkout()
    >>> dossier.is_all_checked_in()
    False
    >>> manager.checkin()
    >>> dossier.is_all_checked_in()
    True


is_all_closed
-------------
it should only be possible resolving a dossier when all tasks are resolved
    >>> wft = portal.portal_workflow
    >>> wft.getInfoFor(task1, 'review_state')
    'task-state-open'
    >>> dossier.is_all_closed()
    False
	>>> task1.task_type="information"
    >>> wft.doActionFor(task2, 'task-transition-open-cancelled')
    >>> wft.doActionFor(task1, 'task-transition-open-tested-and-closed')
    >>> dossier.is_all_closed()
    True


has_valid_enddate
-----------------
In order to be resolved, a dossier needs to have a valid end date.

Currently, our dossier does not have one, so has_valid_enddate() should fail:
    >>> IDossier(dossier).end is None
    True

    >>> dossier.has_valid_enddate()
    False

If the dossier has an end date, it needs to be younger than the latest document's date:
    >>> IDossier(dossier).end = datetime(1999,11,11).date()
    >>> dossier.has_valid_enddate()
    False

Now we set an acceptable end date and try again:
    >>> IDossier(dossier).end = datetime(2050,11,11).date()
    >>> dossier.has_valid_enddate()
    True

We reset the dossier end date again for further testing below:
    >>> IDossier(dossier).end = None



Try to resolve the dossier
--------------------------
    >>> transaction.commit()
    >>> browser.open(dossier.absolute_url() + '/transition-resolve')
    >>> "The subdossier 'Subdossier' needs to be resolved manually." in browser.contents
    True

This is because the subdossier's documents don't have dates that would allow the compution
of the subdossier's end date.
Therefore we set a valid date on one of the documents and try to resolve the dossier again:

    >>> doc1.document_date = datetime(2011,11,11).date()

Now let's try again:

    >>> transaction.commit()
    >>> browser.open(dossier.absolute_url() + '/transition-resolve')
    >>> "The subdossier 'Subdossier' needs to be resolved manually." in browser.contents
    False

    >>> 'transition-archive' in browser.url
    True

It worked, we should now be on the form for archiving the dossier which will be tested next.



Archive
=======
create a second document
    >>> doc2 = createContentInContainer(subdossier,
    ...     'opengever.document.document', title="Doc2", checkConstraints=False)
    >>> doc2
    <Document at /plone/dossier-1/dossier-3/document-2>

default values
--------------
check default value of date field
    >>> doc1.document_date = datetime(2011,11,11).date()
    >>> doc1.reindexObject()
    >>> doc2.document_date = datetime(2012,12,12).date()
    >>> doc2.reindexObject()

When dossier_end_date is empty, it should set the latest document_date as default
    >>> transaction.commit()
    >>> browser.open('http://nohost/plone/dossier-1/transition-archive')
    >>> browser.getControl(name='form.widgets.dossier_enddate').value
    '12. Dezember 2012'

When a dossier end is set and no document_date is later, it should set the dossier_date as default
    >>> IDossier(dossier).end = datetime(2015,1,1).date()
    >>> dossier.reindexObject()
    >>> transaction.commit()
    >>> browser.open('http://nohost/plone/dossier-1/transition-archive')
    >>> browser.getControl(name='form.widgets.dossier_enddate').value
    '01. Januar 2015'

else it should set the latest document_date as default
    >>> IDossier(dossier).end = datetime(2010, 01,01).date()
    >>> dossier.reindexObject()
    >>> transaction.commit()
    >>> browser.open('http://nohost/plone/dossier-1/transition-archive')
    >>> browser.getControl(name='form.widgets.dossier_enddate').value
    '12. Dezember 2012'

filing prefix it should propose the latest document date
    >>> browser.getControl('filing Year').value
    '2012'


check validators
----------------
    all fields are required when given filingnumber is selected
    >>> browser.getControl(name='form.widgets.filing_action:list').value = ['resolve and set filing no']
    >>> browser.getControl('Archive').click()
    >>> browser.url
    'http://nohost/plone/dossier-1/transition-archive'

    check if the subdossier has an older end date than the given end date
    >>> IDossier(subdossier).end = datetime(2015, 1, 1).date()
    >>> subdossier.reindexObject()
    >>> transaction.commit()
    >>> browser.open('http://nohost/plone/dossier-1/transition-archive')
    >>> browser.getControl('filing prefix').value = ['government']
    >>> browser.getControl(name='form.widgets.dossier_enddate').value = 'December 12, 2010'

    >>> browser.getControl('Archive').click()
    >>> browser.url
    'http://nohost/plone/dossier-1/transition-archive'


check the giving of filing numbers
----------------------------------
send form with correct data
    >>> browser.getControl('filing prefix').value = ['government']
    >>> browser.getControl(name='form.widgets.dossier_enddate').value = 'December 12, 2016'
    >>> browser.getControl(name='form.widgets.filing_action:list').value = ['resolve and set filing no']

    >>> browser.getControl('Archive').click()
    >>> browser.url
    'http://nohost/plone/dossier-1'

check the given filing no
    >>> IDossier(dossier).filing_no
    u'OG-Government-2012-1'
    >>> IDossier(subdossier).filing_no
    u'OG-Government-2012-1.1'

check also the filing no and the searchable filing no index
    >>> wrapper = queryMultiAdapter(
    ...         (dossier, portal.portal_catalog), IIndexableObject)
    >>> wrapper.filing_no
    u'OG-Government-2012-1'
    >>> wrapper.searchable_filing_no
    u'OG-Government-2012-1'


    >>> wrapper = queryMultiAdapter(
    ...         (subdossier, portal.portal_catalog), IIndexableObject)
    >>> wrapper.filing_no
    u'OG-Government-2012-1.1'
    >>> wrapper.searchable_filing_no
    u'OG-Government-2012-1.1'

check if the values are assumed to the dossier
    >>> IDossier(dossier).end
    datetime.date(2016, 12, 12)
    >>> IDossier(dossier).filing_prefix
    'government'
