Test the checkout process and the different views wich are use during the checkout process
==========================================================================================

imports
    >>> from plone.namedfile.file import NamedFile
    >>> from plone.dexterity.utils import createContentInContainer
    >>> from zope.component import getUtility
    >>> from zope.component import getMultiAdapter
    >>> import datetime
    >>> from opengever.document.interfaces import ICheckinCheckoutManager
    >>> from Testing import makerequest
    >>> from Products.CMFCore.utils import getToolByName
    >>> from Products.Five.testbrowser import Browser
    >>> from Products.PloneTestCase.setup import portal_owner, default_password
    >>> from opengever.base.interfaces import IRedirector
    

standard test stuff
    >>> self.login()
    >>> self.setRoles(['Manager','Editor','Contributor'])
    >>> folder = makerequest.makerequest(folder)
    >>> folder.REQUEST['SESSION'] = {}
    >>> pr = getToolByName(folder,'portal_repository')


obj2brain
    >>> def obj2brain(obj):
    ...     catalog = getToolByName(obj, 'portal_catalog')
    ...     query = {'path': {'query': '/'.join(obj.getPhysicalPath()),
    ...                       'depth': 0}}
    ...     brains = catalog(query)
    ...     if len(brains) == 0:
    ...         raise Exception('Not in catalog: %s' % obj)
    ...     else:
    ...         return brains[0]


create a document, and get the CheckinCheckoutManager for the document

    >>> mok_file1 = NamedFile('bla bla', filename=u'test.txt')
    >>> doc1 = createContentInContainer(folder, 'opengever.document.document', 
    ...     title=u"Doc One", document_author=u'Hugo Boss', 
    ...     document_date=datetime.date(2011,1,1), file=mok_file1)
    >>> doc2 = createContentInContainer(folder, 'opengever.document.document', 
    ...     title=u"Doc two", file=mok_file1)
    >>> manager = getMultiAdapter((doc1, folder.REQUEST), ICheckinCheckoutManager)
    >>> manager2 = getMultiAdapter((doc2, folder.REQUEST), ICheckinCheckoutManager)



Checkout:
_________

checkout should now allowed, but just for a user with authorization
    >>> manager.is_checkout_allowed()
    True


the annotations should be still empty
    >>> manager.checked_out()

checkout the document
    >>> manager.checkout()
    >>> manager.checked_out()
    'test_user_1_'

cancelling and checkin should be allowed for the 'test_user_1_'
    >>> manager.is_checkin_allowed() and manager.is_cancel_allowed()
    True
    >>> manager.is_checkout_allowed()
    False



checkin and cancelling:
_______________________

    >>> mok_file2 = NamedFile('blubb blubb', filename=u"blubb.txt")
    >>> doc1.file = mok_file2
    >>> manager.checkin(comment="Test commit Nr. 1")

    >>> import transaction
    >>> transaction.commit()

document isn't checked out and the old object is in the history
    >>> manager.checked_out()
    >>> pr.retrieve(doc1, 0).object.file.filename
    u'doc-one.txt'
    >>> doc1.file.filename
    u'blubb.txt'

    >>> manager.checkout()
    >>> manager.checked_out()
    'test_user_1_'

    >>> manager.cancel()
    >>> pr.getHistoryMetadata(doc1).retrieve(2)

    >>> manager.checked_out() == None
    True 


Test the views:
_______________

editing_document:
-----------------

    >>> view = doc1.restrictedTraverse('@@editing_document')()

redirect to the document view, js-redirect to the external link
    >>> view
    'http://nohost/plone/Members/test_user_1_/document-1'

    >>> IRedirector(folder.REQUEST).get_redirects()[0].get('url')
    'http://nohost/plone/Members/test_user_1_/document-1/external_edit'

file is checked out
    >>> manager.checked_out()
    'test_user_1_'


cancel_document_checkouts:
--------------------------
    >>> folder.REQUEST['paths'] = [obj2brain(doc1).getPath(),]
    >>> view = doc1.restrictedTraverse('cancel_document_checkouts').render()
    >>> manager.checked_out()


checkout_documents:
    >>> folder.REQUEST['paths'] = [obj2brain(doc1).getPath(), obj2brain(doc2).getPath()]
    >>> view = doc1.restrictedTraverse('@@checkout_documents').render()
    >>> manager.checked_out()
    'test_user_1_'
    >>> manager2.checked_out()
    'test_user_1_'
